<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="../css/order.css" />
		<link rel="stylesheet" type="text/css" href="../css/box.css" />
		<title></title>
		<script type="text/javascript" src="../script/jquery.js"></script>
	<script type="text/javascript" src="../script/jquery.md5.js"></script>
	<script type="text/javascript" src="../script/jquery.sha1.js"></script>
		
		<script type="text/javascript" src="../script/buildHtml.js"></script>
		<script type="text/javascript" src="../script/common.js"></script>
	</head>
	<body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript">
	var uid;
	var uname;
	var addMonth=3;
	var payType = 1;
	var userInfo;
    var noncestr = getNoncestr();
    var packageInfo;
    var info;
    var amount =100;
	apiready = function(){
		getUserInfo(function(user){
			userInfo = user;
			uid = user.uid;
			uname = user.uname;
		});
		getFeeInfo();
	};
	
	function closexx(){
		api.closeWin({
		    name: 'order'
	    });
	}

function aliPay(){
	var obj = api.require('aliPay');
	var subject = '中介宝手机版费用';
	var body = '中介宝手机版费用';
	var tradeNO = new Date().getTime();
	var notifyURL = 'http://'+server_host+'/c/mobile/user/alipayCallback'
	
	obj.config({
	  partner:'2088711888914717',
	  seller:'2088711888914717',
	  rsaPriKey:'MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAMfIHTbOyuw9ZVoh7Tn/0JF+MPvcgbh1lWdmSi9zOfxSPEEivrlJ2gkzv+Rqtn38Ie2Kh6j4w+lSdwGDYnd5sDsoXa8iOv8boD1gsGmCmOe9d16uKaVB9YTpolSiEGy/1Q5CsHOp2CsHvW6ASbt+pJrM328i+hpc6szrsBJybvLRAgMBAAECgYB2iUi0LUx/kQoiyYB86kjxGqOrvLEHJlUoTav0rXSZPp3bs+bf/26sCRVxTNPMup3S2GAXpMpxFOnhbvgslXo3Aolqh03WxtWu+pSUs1jZmW/enAdfYvLEuX9EHidDB4XkvIHVpeE7T4L4LYhc/l3HsM93fky/z3SVoFq7zabrtQJBAPHntYH5Z/6RW7nXGEa8aPikME9eGxeWVOS4qRqKpdjp3G7SrI3XojB+dtz80BbSqf6BHn7VnWaZXCDsqAdj7z8CQQDTbBYTQTArUlL/l0vFHg3fchFAh+DQzVT6MDOnas2XoJu4hx4xARl2a5y5CtFNvog1veLKSSu2svLRHuLSTqnvAkAcgLrIR8TTH/l42jlIDGcp9N6kW2hBzTrPgFqcf/2uo0+P107xn5jCsgP7YeZ66fORw1D+jNjw/9z1HC1oQYQtAkBPMRlDtRM55ug33JABEbTYkX1s0nifPYoq/IsclqDTvtEVWWcxq9vBw6U8mpSzrj6PAsVESAwbrwPM2OjVJan5AkEAjRuPCLR1rTNoKEJevzC3tfeabtO0pd8D4DRQtAkPpnOsAlRs/vYTewwXV9TmgN1A3bnAdSNrexOAC7pZ/g0aNA==',
	  rsaPubKey:'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnxj/9qwVfgoUh/y2W89L6BkRAFljhNhgPdyPuBV64bfQNN1PjbCzkIM6qRdKBoLPXmKKMiFYnkd6rAoprih3/PrQEB/VsW8OoM8fxn67UDYuyBTqA23MML9q1+ilIZwBC2AQ2UBVOrFXfFl75p6/B5KsiNG9zpgmLCUYuLkxpLQIDAQAB',
	  notifyURL:notifyURL
	},function(ret,err) {
	  
	});

	obj.pay({
	    subject:subject,
	    body:body,
	    amount:amount,
	    tradeNO:tradeNO
	},function(ret,err) {
		if(ret.statusCode=='9000' ){
			alert('支付成功');
			addChargeRecord(addMonth,amount);
		}else{
			blockAlert(ret.msg);
		}
	});

	
}

function getNoncestr() {
    var timestamp = new Date().getTime();
    var Num = "";
    for (var i = 0; i < 6; i++) {
        Num += Math.floor(Math.random() * 10);
    }
    timestamp = timestamp + Num;
    return timestamp;
}
    
function getOrderInfo(noncestr,timestamp,packageInfo) {
    var traceid = "zjb9129588";//用户唯一biaosh
    
    var signatureInfo = "appid=wx1051c7327adfd03f";
    signatureInfo += "&appkey=v2appkey250062";
    signatureInfo += "&noncestr=" + noncestr;
    signatureInfo += "&package=" + packageInfo;
    signatureInfo += "&timestamp=" + timestamp;
    signatureInfo += "&traceid=" + traceid;
    var signatureInfoSign = $.sha1(signatureInfo);
    
    var orderInfo = {
        appid : "wx1051c7327adfd03f",
        traceid : traceid,
        noncestr : noncestr,
        package : packageInfo,
        timestamp : timestamp+"",
        app_signature : signatureInfoSign,
        sign_method : "sha1"
    };
    
    //			alert("orderInfo-->"+$api.jsonToStr(orderInfo));
    return orderInfo;
};
    
function WXpay(){
    var subject='电商宝支付';
    var body='来自电商宝平台支付';
    var amount='0.01';
    var orderId='7896546532';
	packageInfo = getPackage(orderId,amount, subject, body);
	info = getOrderInfo(noncestr,timestamp,packageInfo);
	var token,
		expires;
	var timestamp = Date.parse(new Date());
	timestamp=parseInt(timestamp/1000);
	var weiXin = api.require('weiXin');
	weiXin.getToken({
	    appId: 'wx1051c7327adfd03f',
	    appsecret:'d6eb4ac1d5860d74dd8e65c7dd34c24e'
	},function(ret,err) {
	    if (ret.status) {
	        token = ret.token;
	        expires = ret.expires;
			weiXin.getOrder({
			    token: token,
                orderInfo:info
			},function(ret,err) {
			    if (ret.status) {
                        var signatureInfoT = "appid=wx1051c7327adfd03f";
                        signatureInfoT += "&appkey=v2appkey250062";
                        signatureInfoT += "&noncestr=" + noncestr;
                        signatureInfoT += "&package=" + 'Sign=WXPay';
                        signatureInfoT += "&partnerid=" + '1239578102';
                        signatureInfoT += "&prepayid=" + ret.orderId;
                        signatureInfoT += "&timestamp=" + timestamp;
                        
                        signatureInfoT=$.sha1(signatureInfoT);
			        weiXin.payOrder({
					     orderId: ret.orderId,
					     partnerId:'1239578102',
					     nonceStr:noncestr,
					     timeStamp:timestamp,
					     package:'sign=WXPay',
					     sign:signatureInfoT
					},function(ret,err) {
					     if (ret.status) {
					        api.alert({msg:+'支付成功'});
					     }else{
					        api.alert({msg:err.msg});
					     }
					});
			    }else{
			        api.alert({msg:err.msg});
			    }
			});
	    }else{
	        api.alert({msg:err.msg});
	    }
	});
}

    function getPackage(orderId,amount, subject, body) {
        var packageInfo = "bank_type=WX";
        packageInfo += "&body="+body;
        packageInfo += "&fee_type=1";
        packageInfo += "&input_charset=UTF-8";
        packageInfo += "&notify_url=http://wx.zjb.com.ngrok.com/weixin/";
        packageInfo += "&out_trade_no="+orderId;
        packageInfo += "&partner=1239578102";
        packageInfo += "&spbill_create_ip=127.0.0.0";
        packageInfo += "&total_fee=2";
        var packageInfoSign= packageInfo + "&key=250062";
        packageInfoSign = $.md5(packageInfoSign).toUpperCase();
        
        //因为生成sign(即packageInfoSign)之前packageInfo必须是原文,
        //函数返回值：packageInfo+sign，其中package必须是进行URL编码的,所以又重新拼接了packageInfo
        packageInfo = "bank_type=WX";
        packageInfo += "&body="+encodeURIComponent(body);
        packageInfo += "&fee_type=1";
        packageInfo += "&input_charset=UTF-8";
        packageInfo += "&notify_url="+encodeURIComponent("http://wx.zjb.com.ngrok.com/weixin/");
        packageInfo += "&out_trade_no="+orderId;
        packageInfo += "&partner=1239578102";
        packageInfo += "&spbill_create_ip=127.0.0.0";
        packageInfo += "&total_fee=2";
        
        return packageInfo + "&sign=" + packageInfoSign;
    }
    
function selectBuyMonth(month,id){
	addMonth = month;
	amount = $('#'+id).text();
	$('#info img').css('display','none');
	$('#month'+month).css('display','block');
}

function selectPayWay(payway){
	$('#zhifu .gou').css('display','none');
	$('#'+payway).css('display','block');
}
function getFeeInfo(){
	YW.ajax({
		url: 'http://'+server_host+'/c/mobile/user/feeInfo',
		method:'post',
		cache:false,
		returnAll:false
	},function(ret , err){
		if(ret){
			amount= ret.seasonPay;
			$('#monthPay').text(ret.monthPay);
			$('#seasonPay').text(ret.seasonPay);
			$('#yearPay').text(ret.yearPay);
		}
	});
}
function addChargeRecord(monthAdd , fee){
	var tradeNO = new Date().getTime();
	YW.ajax({
		url: 'http://'+server_host+'/c/mobile/user/paySuccess',
		method:'post',
		cache:false,
		data:{values:{
			monthAdd:monthAdd,userId:uid,uname:uname,tradeNO:tradeNO,fee:fee,payType:payType
		}},
		returnAll:false
	},function(ret , err){
		if(ret && ret.result){
			userInfo.mobileDeadtime = ret.mobileDeadtime;
			userInfo.fufei = ret.fufei;
			api.setPrefs({
	            key:'user',
	            value:JSON.stringify(userInfo)
            });
			
			//更新user页面的服务到期时间
			api.setPrefs({
			    key:'user',
			    value:JSON.stringify(userInfo)
		    });
			api.execScript({
			    name: 'user',
			    script: 'execFrameScript("userFrame","updateDeadtime();");'
			});
			closexx();
		}else{
		}
	});
}
</script>
		
<div class="body">
	<div class="header" >
		<img onclick="closexx();" class="back" src="../image/back.png"/><div class="title">购买服务</div>
	</div>
		<div class="wrap">
			<table id="info" style="">
				<tr>
					<td class="label" colspan="3">中介宝产品移动端服务</td>
				</tr>
				<tr tapmode="tapped" onclick="selectBuyMonth(1,'monthPay');">
					<td class="label">月付: </td><td><span id="monthPay">40</span>元</td><td><img id="month1" src="../image/gou.png"/></td>
				</tr>
				<tr tapmode="tapped" onclick="selectBuyMonth(3,'seasonPay');">
					<td class="label">季付: </td><td><span id="seasonPay">100</span>元</td><td><img id="month3" style="display:block" src="../image/gou.png"/></td>
				</tr>
				<tr tapmode="tapped" onclick="selectBuyMonth(12,'yearPay');">
					<td class="label">年付: </td><td><span id="yearPay">400</span>元</td><td><img id="month12" src="../image/gou.png"/></td>
				</tr>
			</table>
			
			<table id="zhifu" style="">
				<tr tapmode="tapped" onclick='selectPayWay("ali");'>
					<td width="50" ><img class="img"  style="float:left" src="../image/zhifubao.jpg"/></td>
					<td><div class="fangshi">支付宝支付</div><div class="desc">推荐有支付宝账号的用户使用</div></td>
					<td><img class="gou" id="ali" style="display:block" src="../image/gou.png"/></td>
				</tr>
			</table>
		</div>
		
		<div class="footer" style="bottom:20px;">
			<button class="call" onclick="aliPay();">确认支付</button>
		</div>
<!--	<!--	<!--
		<div class="footer" style="bottom:20px;">
			<button class="call" onclick="WXpay();">确认支付</button>
		</div>-->
</div>
		
	</body>
</html>
