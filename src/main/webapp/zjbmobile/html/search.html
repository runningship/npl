<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<link rel="stylesheet" type="text/css" href="../css/search.css" />
<title></title>
<script type="text/javascript" src="../script/jquery.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/buildHtml.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript">
var mjiStart='';
var mjiEnd='';
var zjiaStart='';
var zjiaEnd='';
var djiaStart='';
var djiaEnd='';
var lcengStart='';
var lcengEnd='';
var searchText='';
var ztai;
var quyus=[];
var historySearchCount;
function doSearch(){
	setTimeout(function(){
		mjiStart = $('#mjiStart').val();
		mjiEnd = $('#mjiEnd').val();
		zjiaStart = $('#zjiaStart').val();
		zjiaEnd = $('#zjiaEnd').val();
		djiaStart = $('#djiaStart').val();
		djiaEnd = $('#djiaEnd').val();
		lcengStart = $('#lcengStart').val();
		lcengEnd = $('#lcengEnd').val();
		searchText = $('#searchText').val();
		var tmp = [];
		$('#table_status .selected').each(function(){
			tmp.push($(this).attr('data'));
		});
		ztai = tmp.join();
		
		var tmp2 = [];
		$('#table_quyu .selected').each(function(){
			tmp2.push($(this).attr('data'));
		});
		quyus = tmp2.join();
	
		var pageParam = JSON.parse('{}');
		pageParam.title = "搜索结果";
		pageParam.pageName = "searchResult";
		pageParam.mjiStart = mjiStart;
		pageParam.mjiEnd = mjiEnd;
		pageParam.zjiaStart = zjiaStart;
		pageParam.zjiaEnd = zjiaEnd;
		pageParam.djiaStart = djiaStart;
		pageParam.djiaEnd = djiaEnd;
		pageParam.lcengStart =lcengStart;
		pageParam.lcengEnd = lcengEnd;
		pageParam.search = searchText;
		pageParam.ztai = ztai;
		pageParam.quyu = quyus;
		
		AddSelect(pageParam);
	    api.openWin({
	        name: pageParam.pageName,
		    pageParam:pageParam,
			url: 'wrap.html',
	        bgColor: '#fff',
	    });
	},500);
	
	
}

function getQuyus(){
    $('.quyu .selected').each(function(i){ 
      if ($(this).text()!='$[name]') {
        quyus[i-1] = $(this).attr('data');
      }
    })
}

function AddSelect(pageParam){
	
	var SelectBox="<div onclick='searchByHistory(this)' tapmode='tapped' data='"+JSON.stringify(pageParam)+"' class='hItem'>";
	if(quyus!=[]){
		SelectBox = SelectBox + '<span>区域：'+quyus+'</span>';
	}else{
		SelectBox = SelectBox + '<span>区域：全部</span>';
	}
	if(searchText!=''){
		SelectBox = SelectBox + '<span>楼盘：'+searchText+'</span>';
	}
	if(mjiStart!=''||mjiEnd!=''){
		if(mjiStart==''){
			SelectBox = SelectBox + '<span>面积：小于'+mjiEnd+'</span>';
		}else if(mjiEnd==''){
			SelectBox = SelectBox + '<span>面积：大于'+mjiStart+'</span>';
		}else{
			SelectBox = SelectBox + '<span>面积：'+mjiStart+'-'+mjiEnd+'</span>';
		}
	}
	if(djiaStart!=''||djiaEnd!=''){
		if(djiaStart==''){
			SelectBox = SelectBox + '<span>单价：小于'+djiaEnd+'</span>';
		}else if(mjiEnd==''){
			SelectBox = SelectBox + '<span>单价：大于'+djiaStart+'</span>';
		}else{
			SelectBox = SelectBox + '<span>单价：'+djiaStart+'-'+djiaEnd+'</span>';
		}
	}
	if(zjiaStart!=''||zjiaEnd!=''){
		if(zjiaStart==''){
			SelectBox = SelectBox + '<span>总价：小于'+zjiaEnd+'</span>';
		}else if(mjiEnd==''){
			SelectBox = SelectBox + '<span>总价：大于'+zjiaStart+'</span>';
		}else{
			SelectBox = SelectBox + '<span>总价：'+zjiaStart+'-'+zjiaEnd+'</span>';
		}
	}
	if(lcengStart!=''||lcengEnd!=''){
		if(lcengStart==''){
			SelectBox = SelectBox + '<span>楼层：小于'+lcengEnd+'</span>';
		}else if(mjiEnd==''){
			SelectBox = SelectBox + '<span>楼层：大于'+lcengStart+'</span>';
		}else{
			SelectBox = SelectBox + '<span>楼层：'+lcengStart+'-'+lcengEnd+'</span>';
		}
	}
	SelectBox += '<span>状态：'+$('#status_table .selected').text()+'</span>';
	SelectBox +='</div>';
	$('#searchHistoryWrap').prepend(SelectBox);
	if(historySearchCount>=10){
//		remove last one
		var xx = $('#searchHistoryWrap');
		xx.children()[xx.children().length-1].remove();
		//return;
	}
	api.parseTapmode();
	
	//save to history
	api.getPrefs({
    	key:'searchHistory'
    },function(ret,err){
    	var result = SelectBox+';';
    	if(ret.value){
    		var arr = ret.value.split(';');
			var tmp = SelectBox+';';
			for(var i=0;i<arr.length;i++){
				if(i<9){
					tmp=tmp+arr[i]+";";
				}
			}
			result = tmp;
    	}
		api.setPrefs({
            key:'searchHistory',
            value:result
        });
        historySearchCount++;
    });
}

function selectStatus(obj){
	$('#allStatus').removeClass('selected');
	$(obj).toggleClass('selected');
}

function selectAllStatus(obj){
	$('.status span').removeClass('selected');
	$(obj).addClass('selected');
}

function selectQuyu(obj){
	$('#allQuyu').removeClass('selected');
	$(obj).toggleClass('selected');
}

function selectAllQuyu(obj){
	$('#quyuWrap span').removeClass('selected');
	$(obj).addClass('selected');
}

function closexx(){
	api.closeWin({
	    name: 'search'
    });
}

function clearHistory(){
	$('#searchHistoryWrap').empty();
	api.setPrefs({
	    key:'searchHistory',
	    value:''
    });
    historySearchCount=0;
}

function searchByHistory(item){
	var data = $(item).attr('data');
	if(!data){
		return;
	}
	var jsonData = JSON.parse(data);
	//填充条件
	
	setTimeout(function(){
		api.openWin({
	        name: 'searchResult',
		    pageParam:jsonData,
			url: 'wrap.html',
	        bgColor: '#fff',
	    });	
	},500);
	
}

function openCityWindow(){
	api.openWin({
        name: 'citys',
	    pageParam:{parentPage:'search'},
		url: 'citys.html',
        bgColor: '#fff',
    });
}

function setCity(pinyin,name){
	buildQuyuItems();
}

function buildQuyuItems(){
getCityInfo(function(city){
	if(city){
//		$('#allQuyu').text(city.name);
//		blockAlert(JSON.stringify(city));
		buildHtmlWithJsonArray('quyuTemplate',city.quyus , false, false);
		//添加全部按钮
		$('#quyuWrap').prepend('<div class="quyuItem selected" data="" id="allQuyu" onclick="selectAllQuyu(this);">全部</div>');
	}
});
}
apiready=function(){
	var $header = $api.dom('header');
	$api.fixIos7Bar($header);
    buildQuyuItems();
    api.getPrefs({
    	key:'searchHistory'
    },function(ret,err){
    	if(ret.value){
			var arr = ret.value.split(';');
			var jsonArr = JSON.parse('[]');
			for(var i=0;i<arr.length;i++){
				if(!arr[i]){
					continue;
				}
				var json = JSON.parse('{}');
//				blockAlert(arr[i]);
				json.html = arr[i];
				jsonArr.push(json);
			}
			
			historySearchCount = jsonArr.length;
			buildHtmlWithJsonArray('hisRepeat',jsonArr , true, false);
			api.parseTapmode();
    	}else{
    		historySearchCount=0;
    	}
    });
};
</script>
</head>
<body>
	<div id="wrap">
	<div class="header" style="margin-top:15px;">
		<table style="width:100%;border-spacing:0px;">
			<tr>
				<td style="width:40px;"><img onclick="closexx();" class="back" src="../image/back.png"/></td>
				<td><input placeholder="楼盘名称" id="searchText" /></td>
				<td style="width:40px;"><img onclick="doSearch();" class="search" src="../image/search.png" /></td>
			</tr>
		</table>
	</div>
	
	<div class="searchPanel">
		<table style="width:100%;" id="table_quyu" >
			<tr class="quyu row">
				<td class="label" style="vertical-align:text-top;"><span> 区域: </span></td>
				<td colspan="3">
				<span id="quyuWrap">
					<div class="quyuItem quyuTemplate" data="$[name]" onclick="selectQuyu(this);" style="display:none">$[name]</div>
				</span>
				</td>
			</tr>
		</table>
		<table id="status_table" style="width:100%;">
			<tr class="area row">
				<td class="label"><span>面积: </span></td>
				<td class="input"><input type="number" id="mjiStart"/></td>
				<td class="sep">-</td>
				<td class="input"><input type="number" id="mjiEnd"/></td>
				<td class="unit">m2</td>
			</tr>
			<tr class="area row">
				<td class="label"><span>总价: </span></td>
				<td class="input" ><input type="number" id="zjiaStart"/></td>
				<td class="sep">-</td>
				<td class="input" ><input type="number" id="zjiaEnd"/></td>
				<td class="unit">万</td>
			</tr>
			<tr class="area row">
				<td class="label"><span>单价: </span></td>
				<td class="input" ><input type="number" id="djiaStart"/></td>
				<td class="sep">-</td>
				<td class="input"><input type="number" id="djiaEnd"/></td>
				<td class="unit">元</td>
			</tr>
			<tr class="area row">
				<td class="label"><span>楼层: </span></td>
				<td class="input"><input type="number" id="lcengStart"/></td>
				<td class="sep">-</td>
				<td class="input"><input type="number" id="lcengEnd"/></td>
				<td class="unit">层</td>
			</tr>
			<tr clsss="status row">
				<td class="label"><span>状态: </span></td>
				<td colspan="3">
					<table style="width:100%" id="table_status">
						<tr>
							<td><div class="item selected" id="allStatus" onclick="selectAllStatus(this);" >全部</div></td>
							<td><div class="item" onclick="selectStatus(this);" data="4" value="">在售</div></td>
							<td><div class="item" onclick="selectStatus(this);" data="6">已售</div></td>
							<td><div class="item" onclick="selectStatus(this);" data="7">停售</div></td>
						</tr>
					</table>
				</td>
				<td></td>
			</tr>
		</table>
		
	</div>
	
	<div id="searchHistory">
		<div id="searchHistoryWrap">
			<span class="hisRepeat" style="display:none">$[html]</span>
		</div>
		<div class="clear" onclick="clearHistory();">清空历史记录</div>
	</div>
	
	</div>
</body>
</html>
